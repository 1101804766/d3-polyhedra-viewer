<!DOCTYPE html>
<html lang="en" style='width:100%; height:100%; border:0; margin:0; padding:0;'>
  <head>
    <!-- JQuery -->
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>

    <!-- Boostrap -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <!-- End Boostrap -->

    <!-- X3DOM -->
    <script type='text/javascript' src='http://www.x3dom.org/download/x3dom.js'> </script> 
    <link rel='stylesheet' type='text/css' href='http://www.x3dom.org/download/x3dom.css'></link> 

    <!-- D3 -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

  </head>
  <body style='width:100%; height:100%; border:0; margin:0; padding:0;'>
    <nav class="navbar navbar-default navbar-fixed-top" style="position:absolute; left:0px; top:0px; opacity:0.75">
      <div class="container-fluid">
        <div class="navbar-header">
          <p class="navbar-brand">Johnson Solid Viewer</p>
        </div>
        <form class="navbar-form navbar-left">
          <div class="form-group">
            <button id="dec" type="button" class="btn"><span class="glyphicon glyphicon-chevron-left"></span></button>
            <button id="inc" type="button" class="btn"><span class="glyphicon glyphicon-chevron-right"></span></button>
            <label class="sr-only" for="jn">Johnson number</label>
            <div class="input-group">
              <div class="input-group-addon">J</div>
              <input class="form-control" type="number" id="jn" value="1" min="1" max="92" placeholder="Enter Johnson number">
            </div>
          </div>
          <input id="solid-name" class="form-control" type="text" value="square pyramid" placeholder="Solid name here..." readonly>
        </form>
        <!-- Button trigger modal -->
        <button type="button" class="pull-right btn navbar-btn" data-toggle="modal" data-target="#info"><span class="glyphicon glyphicon-info-sign"></span></button>
      </div>
    </nav>

    <!-- App information -->
    <div class="modal fade" id="info" tabindex="-1" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">About this Demo</h4>
          </div>
          <div class="modal-body">
            <p>This demo allows you to manipulate virtual models of the 92 <a href="http://en.wikipedia.org/wiki/Johnson_solid">Johnson solids</a>.</p>
            <p>It was built with
            <a href="http://www.x3dom.org/">X3DOM</a>,
            <a href="http://d3js.org/">d3.js</a>, and
            <a href="http://getbootstrap.com/">Bootstrap</a>.
            </p>
            <p>Geometric data taken from George W. Hart's <a href="http://www.georgehart.com/virtual-polyhedra/johnson-index.html">Virtual Polyhedra</a>.
            <p>More polyhedra and features coming soon!</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- X3D viewer -->
    <x3d style='width:100%; height:100%; border:0; margin:0; padding:0;'> 
      <scene>
        <viewpoint position="0,0,5"></viewpoint>
        <shape>
          <appearance>
            <material></material>
          </appearance>
          <indexedfaceset colorPerVertex="false">
            <coordinate></coordinate>
            <color></color>
          </indexedfaceset>
        </shape>

        <shape>
          <indexedlineset>
            <coordinate>
          </indexedlineset>
        </shape>
      </scene> 
    </x3d>           

    <script>
      // Disable double-clicking to change rotation point
      x3dom.Viewarea.prototype.onDoubleClick = function() {}

      // Make sure the submit doesn't refresh the page
      $("form").submit(function(event) {
        event.preventDefault();
      });

      // x3dom will bug out and won't process the solid data if
      // it's not seeded.
      var mock = {
        "edges": [[4, 1], [1, 0], [0, 3], [3, 4], 
                  [4, 2], [2, 1], [2, 0], [2, 3]], 
        "vertices": [
          [-0.729665, 0.670121, 0.319155], 
          [-0.655235, -0.29213, -0.754096], 
          [-0.093922, -0.607123, 0.537818], 
          [0.702196, 0.595691, 0.485187], 
          [0.776626, -0.36656, -0.588064]], 
        "faces": [[1, 4, 2], [0, 1, 2], [3, 0, 2], [4, 3, 2], [4, 1, 0, 3]]
      };
      render(mock);

      // Get the rest of the polyhedron data
      $.getJSON('data/johnson.json', function(data) {
        var changeSolid = function(n) {
          if (n >= 1 && n <= 92) {
            var solid = data[n-1];
            $('#solid-name').attr('value', solid.name);
            render(solid);
          }
        }
        // Update the viewer based on user input
        // TODO Use some data framework to simplify this code
        $('#jn').change(function() {
          var value = parseInt($("#jn").val());
          changeSolid(value);
        }).change();

        $('#dec').click(function() {
          var value = parseInt($("#jn").val());
          value--;
          if (value >= 1 && value <= 92) {
            $("#jn").val(value);
            changeSolid(value);
          }
        });
        $('#inc').click(function() {
          var value = parseInt($("#jn").val());
          value++;
          if (value >= 1 && value <= 92) {
            $("#jn").val(value);
            changeSolid(value);
          }
        });
      });        

      // Render the given polyhedron given its geometric data
      function render(solid) {
        var faces = d3.select("IndexedFaceSet").datum(solid);

        renderVertices(faces);

        var color = faces.select("color").datum(solid);
        color.attr("color", function(d) {
          return joinListOfLists(', ', ' ', d.faces.map(function(face) {
            return getColor(face.length);
          }));
        });

        faces.attr("coordIndex", function(d) {
          return joinListOfLists(' -1 ', ' ', d.faces);
        });

        // Render the edges (outlines)
        var edges = d3.select("IndexedLineSet").datum(solid);
        edges.attr("coordIndex", function(d) {
          return joinListOfLists(' -1 ', ' ', d.edges);
        });
        renderVertices(edges);
      }

      // Render the vertices of a face or edge set
      function renderVertices(elem) {
        elem.select('Coordinate').datum(function(d) {
          return d.vertices; 
        }).attr('point', function(vertices) {
          return joinListOfLists(', ', ' ', vertices);
        });
      }

      // Get the color for a polygon with n sides
      function getColor(n) {
        var category10 = d3.scale.category10().domain([5,3,6,4,8,10]);
        var rgb = d3.rgb(category10(n));
        return [rgb.r, rgb.g, rgb.b].map(function(d) { return d / 255; });
      }

      // Join a list of lists with the given inner and outer separators
      function joinListOfLists(outerSep, innerSep, list) {
        return list.map(function(elem) {
          return elem.join(innerSep);
        }).join(outerSep);
      }
    </script>
        

  </body>
</html>
