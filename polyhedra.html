<!DOCTYPE html>
<html lang="en" style='width:100%; height:100%; border:0; margin:0; padding:0;'>
  <head>
    <!-- JQuery -->
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>

    <!-- Boostrap -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <!-- End Boostrap -->

    <!-- X3DOM -->
    <script type='text/javascript' src='http://www.x3dom.org/download/x3dom.js'> </script> 
    <link rel='stylesheet' type='text/css' href='http://www.x3dom.org/download/x3dom.css'></link> 

    <!-- D3 -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

  </head>
  <body style='width:100%; height:100%; border:0; margin:0; padding:0;'>
    <nav class="navbar navbar-default navbar-fixed-top" style="position:absolute; left:0px; top:0px; opacity:0.75">
      <div class="container-fluid">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <div class="navbar-header">
          <p class="navbar-brand">Polyhedra Viewer</p>
        </div>

        <div class="collapse navbar-collapse" id="navbar-collapse">
          <ul id="dropdowns" class="nav navbar-nav">
          </ul>
        </div>
      </div>
    </nav>


    <!-- X3D viewer -->
    <x3d style='width:100%; height:100%; border:0; margin:0; padding:0;'> 
      <scene>
        <viewpoint position="0,0,5"></viewpoint>
        <shape>
          <appearance>
            <material></material>
          </appearance>
          <indexedfaceset colorPerVertex="false">
            <coordinate></coordinate>
            <color></color>
          </indexedfaceset>
        </shape>

        <shape>
          <indexedlineset>
            <coordinate>
          </indexedlineset>
        </shape>
      </scene> 
    </x3d>           

    <script>
      // Disable double-clicking to change rotation point
      x3dom.Viewarea.prototype.onDoubleClick = function() {}

      // x3dom will bug out and won't process the solid data if
      // it's not seeded.
      var mock = {
        "edges": [[4, 1], [1, 0], [0, 3], [3, 4], 
                  [4, 2], [2, 1], [2, 0], [2, 3]], 
        "vertices": [
          [-0.729665, 0.670121, 0.319155], 
          [-0.655235, -0.29213, -0.754096], 
          [-0.093922, -0.607123, 0.537818], 
          [0.702196, 0.595691, 0.485187], 
          [0.776626, -0.36656, -0.588064]], 
        "faces": [[1, 4, 2], [0, 1, 2], [3, 0, 2], [4, 3, 2], [4, 1, 0, 3]]
      };
      render(mock);

      // Get the rest of the polyhedron data
      d3.json('data/polyhedra.json', function(error, data) {
        // Update the UI with the names
        var groups = data.groups;
        console.log(groups);
        var dropdowns = d3.select("#dropdowns");
        var lists = dropdowns.selectAll('li.dropdown').data(groups);

        lists.enter().append('li').classed('dropdown', true);
        var links = lists.append('a');
        links.classed('dropdown-toggle', true)
          .attr('data-toggle', 'dropdown')
          .attr('role', 'button')
          .text(function(d) { return d.group_name; });

        var solids = lists.append('ul')
          .classed('dropdown-menu', true)
          .attr('role', 'menu')
          .style('height', 'auto')
          .style('max-height', '400px')
          .style('overflow-x', 'hidden');

        var elts = solids.selectAll('li').data(function(d) { return d.polyhedra; })
        .enter().append('li')
        .on('click', function(d) {
          d3.selectAll('li').classed('active', false);
          d3.select(this).classed('active', true);
        });

        elts.append('a')
        .attr('href', '#')
        .text(function(d) { return d.name; })
        .on('click', function(d) {
          render(d); 
        });

        $('.dropdown-menu li').click(function(e) {
                  e.stopPropagation();
                      });
      });

      // Render the given polyhedron given its geometric data
      function render(solid) {
        var faces = d3.select("IndexedFaceSet").datum(solid);

        renderVertices(faces);

        var color = faces.select("color").datum(solid);
        color.attr("color", function(d) {
          return joinListOfLists(', ', ' ', d.faces.map(function(face) {
            return getColor(face.length);
          }));
        });

        faces.attr("coordIndex", function(d) {
          return joinListOfLists(' -1 ', ' ', d.faces);
        });

        // Render the edges (outlines)
        var edges = d3.select("IndexedLineSet").datum(solid);
        edges.attr("coordIndex", function(d) {
          return joinListOfLists(' -1 ', ' ', d.edges);
        });
        renderVertices(edges);
      }

      // Render the vertices of a face or edge set
      function renderVertices(elem) {
        elem.select('Coordinate').datum(function(d) {
          return d.vertices; 
        }).attr('point', function(vertices) {
          return joinListOfLists(', ', ' ', vertices);
        });
      }

      // Get the color for a polygon with n sides
      function getColor(n) {
        var category10 = d3.scale.category10().domain([5,3,6,4,8,10]);
        var rgb = d3.rgb(category10(n));
        return [rgb.r, rgb.g, rgb.b].map(function(d) { return d / 255; });
      }

      // Join a list of lists with the given inner and outer separators
      function joinListOfLists(outerSep, innerSep, list) {
        return list.map(function(elem) {
          return elem.join(innerSep);
        }).join(outerSep);
      }
    </script>
        

  </body>
</html>
